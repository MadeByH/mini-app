<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فروشگاه و خدمات ربات</title>
    <link rel="stylesheet" href="style.css"> <!-- فرض می‌کنیم style.css دارید -->
    <style>
        /* استایل‌های اصلی اینجا قرار می‌گیرد */
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        header { background-color: #4CAF50; color: white; padding: 15px; text-align: center; position: relative; }
        .settings-button { position: absolute; left: 15px; top: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .content { padding: 20px; text-align: center; }
        .content button, .ad-button { background-color: #4CAF50; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .content button:hover, .ad-button:hover { background-color: #45a049; }
        .ad-section { background-color: #e0e0e0; padding: 15px; margin-top: 20px; border-radius: 8px; text-align: center; min-height: 100px; display: flex; justify-content: center; align-items: center;}
        .ad-content img, .ad-content video { max-width: 100%; height: auto; border-radius: 5px; margin-top: 10px;}
        footer { text-align: center; padding: 10px; margin-top: 30px; font-size: 12px; color: #777; }
        #settings-panel { display: none; position: fixed; top: 0; right: 0; width: 250px; background-color: #fff; box-shadow: -2px 0 5px rgba(0,0,0,0.2); padding: 20px; height: 100%; z-index: 1000; }
        #settings-panel.dark { background-color: #333; color: white; }
        #settings-panel button { width: calc(100% - 10px); margin-bottom: 10px; }
        .theme-switcher { display: flex; align-items: center; margin-bottom: 15px; }
        .theme-switcher label { margin-right: 10px; }
        .color-picker { margin-bottom: 15px; }
        .color-picker label { display: block; margin-bottom: 5px; }
        .color-picker input[type="color"] { width: 50px; height: 30px; border: none; cursor: pointer; vertical-align: middle; }
        /* اضافه کردن استایل برای رنگ اصلی */
        :root { --primary-color: #4CAF50; }
        .dark { --primary-color: #66bb6a; }
        .content button, .ad-button, header, #settings-panel.dark button { background-color: var(--primary-color) !important; }
        .content button:hover, .ad-button:hover { background-color: #45a049 !important; } /* ممکن است نیاز به تنظیم رنگ هاوِر باشد */
    </style>
</head>
<body>

    <header>
        <!-- لوگو اینجا قرار می‌گیرد -->
        <h1>فروشگاه و خدمات ربات</h1>
        <button class="settings-button" onclick="toggleSettings()">⚙️</button>
    </header>

    <main class="content">
        <button onclick="openLink('https://t.me/your_buy_coin_link')">خرید سکه</button>
        <button onclick="openLink('https://t.me/your_ads_tariff_link')">تعرفه تبلیغات</button>
        <button onclick="openLink('https://t.me/your_guide_link')">راهنما</button>
        <button onclick="openLink('https://t.me/your_channels_bots_link')">کانال‌ها و ربات‌ها</button>
    </main>

    <section class="ad-section">
        <div id="ad-display">
            <!-- تبلیغات اینجا نمایش داده می‌شود -->
            در حال بارگذاری تبلیغات...
        </div>
    </section>

    <footer>
        <p>&copy; 2024 فروشگاه و خدمات ربات. تمامی حقوق محفوظ است.</p>
    </footer>

    <!-- پنل تنظیمات -->
    <div id="settings-panel">
        <h2>تنظیمات</h2>
        <div class="theme-switcher">
            <label for="themeToggle">حالت شب:</label>
            <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
        </div>
        <div class="color-picker">
            <label for="primaryColorPicker">رنگ اصلی:</label>
            <input type="color" id="primaryColorPicker" value="#4CAF50" onchange="updatePrimaryColor()">
        </div>
        <button onclick="toggleSettings()" style="background-color: var(--primary-color);">بستن</button>
    </div>

    <!-- اسکریپت‌ها -->
    <script src="https://tapi.bale.ai/miniapp.js?3"></script>
    <script>
        // ---- تنظیمات اولیه ----
        let currentAd = null;
        const ADS_API_URL = 'https://mini-app-add-bot.onrender.com/ads'; // URL API تبلیغات

        // ---- توابع کمکی ----
        function getElement(id) {
            return document.getElementById(id);
        }

        // ---- توابع مینی‌اپ بله ----
        function initializeBaleMiniApp() {
            if (window.WebApp) {
                // تلاش برای آماده‌سازی مینی‌اپ
                //WebApp.ready(); // این خط باید در جایی اجرا شود که مطمئن باشیم WebApp مقداردهی شده است

                // اگر WebApp.ready() در زمان بارگذاری اولیه اجرا نشود، ممکن است لازم باشد بعداً صدا زده شود.
                // اما معمولا با بارگذاری script باید آماده باشد.

                console.log("Bale WebApp SDK is available.");
            } else {
                console.error("Bale WebApp SDK is not available. Are you running this inside the Bale app?");
            }
        }

        // ---- توابع مربوط به لینک‌ها و تبلیغات ----

        // تابع اصلی برای باز کردن لینک‌ها
        function openLink(url) {
            console.log(`Attempting to open link: ${url}`);
            if (window.WebApp && window.WebApp.openLink) {
                try {
                    // WebApp.openLink(url, { try_instant_view: true }); // با این پارامتر تست کنید
                    window.WebApp.openLink(url); // بدون پارامتر تست کنید
                    console.log("Opened link using WebApp.openLink.");
                } catch (error) {
                    console.error("Error using WebApp.openLink:", error);
                    // اگر WebApp.openLink خطا داد، به fallback متوسل شوید
                    window.open(url, "_blank");
                    console.log("Falling back to window.open.");
                }
            } else {
                // اگر WebApp در دسترس نباشد (یعنی در مرورگر عادی هستیم)
                window.open(url, "_blank");
                console.log("WebApp not available, opened link using window.open.");
            }
        }

        // ثبت کلیک روی تبلیغ (شما باید این تابع را پیاده‌سازی کنید)
        function registerClick(adId) {
            console.log(`Registering click for ad ID: ${adId}`);
            // فرض می‌کنیم شما یک API دارید که با این URL تماس می‌گیرد
            fetch(ADS_API_URL + '/click', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adId: adId, botId: 'YOUR_BOT_ID' /* شناسه ربات خود را اینجا قرار دهید */ })
            }).then(response => {
                if (!response.ok) console.error("Failed to register click:", response.statusText);
            }).catch(error => {
                console.error("Error registering click:", error);
            });
        }

        // دریافت تبلیغات از API
        async function fetchAds() {
            console.log("Fetching ads...");
            try {
                const response = await fetch(ADS_API_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const ads = await response.json();
                console.log("Ads fetched:", ads);
                return ads;
            } catch (error) {
                console.error("Failed to fetch ads:", error);
                getElement('ad-display').innerHTML = 'خطا در بارگذاری تبلیغات.';
                return [];
            }
        }

        // نمایش یک تبلیغ تصادفی
        function showRandomAd(ads) {
            if (!ads || ads.length === 0) {
                getElement('ad-display').innerHTML = 'تبلیغی برای نمایش وجود ندارد.';
                return;
            }
            const adIndex = Math.floor(Math.random() * ads.length);
            currentAd = ads[adIndex];
            const adDisplay = getElement('ad-display');

            let adHtml = '';
            if (currentAd.type === 'text') {
                adHtml = `<p>${currentAd.content}</p>`;
            } else if (currentAd.type === 'image' && currentAd.url) {
                adHtml = `<img src="${currentAd.url}" alt="تبلیغ تصویری">`;
            } else if (currentAd.type === 'video' && currentAd.url) {
                adHtml = `<video controls src="${currentAd.url}"></video>`;
            } else {
                adHtml = '<p>فرمت تبلیغ نامشخص است.</p>';
            }

            // افزودن دکمه کلیک به تبلیغ
            const adButtonHtml = `<button class="ad-button" onclick="handleAdClick('${currentAd.id}', '${currentAd.link}')">مشاهده تبلیغ</button>`;
            adDisplay.innerHTML = adHtml + adButtonHtml;
        }

        // مدیریت کلیک روی دکمه تبلیغ
        function handleAdClick(adId, adLink) {
            registerClick(adId); // ثبت کلیک قبل از باز کردن لینک
            openLink(adLink);   // باز کردن لینک تبلیغ
        }

        // بارگذاری و نمایش تبلیغات اولیه و تنظیم آپدیت دوره‌ای
        async function loadAndShowAds() {
            const ads = await fetchAds();
            showRandomAd(ads);
            // آپدیت تبلیغ هر 30 ثانیه
            setInterval(() => showRandomAd(ads), 30000);
        }

        // ---- توابع تنظیمات ----
        function toggleSettings() {
            const panel = getElement('settings-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function setTheme(isDark) {
            if (isDark) {
                document.body.classList.add('dark');
                getElement('settings-panel').classList.add('dark');
            } else {
                document.body.classList.remove('dark');
                getElement('settings-panel').classList.remove('dark');
            }
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            getElement('settings-panel').classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function updatePrimaryColor() {
            const colorPicker = getElement('primaryColorPicker');
            const color = colorPicker.value;
            document.documentElement.style.setProperty('--primary-color', color);
            localStorage.setItem('primaryColor', color);

            // به‌روزرسانی رنگ دکمه بستن پنل تنظیمات
            const closeButton = getElement('settings-panel').querySelector('button');
            if (closeButton) {
                closeButton.style.backgroundColor = color;
            }
        }

        // ---- اجرای اولیه ----
        document.addEventListener('DOMContentLoaded', () => {
            // **مهم:** مقداردهی اولیه WebApp باید اینجا یا قبل از آن انجام شود
            initializeBaleMiniApp();

            // بارگذاری تنظیمات ذخیره شده
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                setTheme(true);
                getElement('themeToggle').checked = true;
            } else {
                setTheme(false);
                getElement('themeToggle').checked = false;
            }

            const savedColor = localStorage.getItem('primaryColor');
            if (savedColor) {
                getElement('primaryColorPicker').value = savedColor;
                document.documentElement.style.setProperty('--primary-color', savedColor);
                 const closeButton = getElement('settings-panel').querySelector('button');
                if (closeButton) {
                    closeButton.style.backgroundColor = savedColor;
                }
            } else {
                 // اگر رنگی ذخیره نشده بود، رنگ پیش‌فرض را تنظیم کن
                updatePrimaryColor();
            }


            // بارگذاری تبلیغات
            loadAndShowAds();

            // اطمینان از فراخوانی WebApp.ready() در صورت نیاز
            // اگر WebApp SDK به صورت خودکار آماده نشود، ممکن است نیاز باشد این خط را فعال کنید:
            // if (window.WebApp && window.WebApp.ready) {
            //     window.WebApp.ready();
            //     console.log("WebApp.ready() called manually.");
            // }
        });

        // اگر از $ استفاده می‌کنید (مثلا با jQuery)، اطمینان حاصل کنید که $ تعریف شده است
        // اگر این کد را در محیطی اجرا می‌کنید که $ به معنی document.ready است،
        // ممکن است نیاز باشد این کد را درون آن قرار دهید.

        // مثال: اگر از jQuery استفاده می‌کنید:
        /*
        $(document).ready(function() {
            initializeBaleMiniApp();
            // ... سایر کدهای بارگذاری ...
            loadAndShowAds();
        });
        */

    </script>

</body>
</html>
